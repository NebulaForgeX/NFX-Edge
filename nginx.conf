# ============================================
# ğŸ”§ Universal SPA Frontend Nginx Config
# Author: Lucas Lyu (for SJGZTEA / PQTTEC / LyuLucas)
# ============================================

# å®šä¹‰ä¸€ä¸ª HTTP æœåŠ¡å™¨å—
server {
    # ç›‘å¬ç«¯å£ 80ï¼ˆHTTP ç«¯å£ï¼‰
    # æ³¨æ„ï¼šè¿™æ˜¯å®¹å™¨å†…çš„ç«¯å£ï¼ŒTraefik é€šè¿‡ Docker ç½‘ç»œç›´æ¥è®¿é—® Nginx å®¹å™¨çš„ 80 ç«¯å£
    # è¿™ä¸ªé€šä¿¡åœ¨ Docker ç½‘ç»œå†…éƒ¨è¿›è¡Œï¼Œä¸ç»è¿‡ä¸»æœºç«¯å£æ˜ å°„
    listen 80;
    
    # æœåŠ¡å™¨åç§°ï¼Œä½¿ç”¨ _ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰åŸŸå
    # å› ä¸ºæ‰€æœ‰åŸŸåéƒ½é€šè¿‡ Traefik åå‘ä»£ç†ï¼Œè¿™é‡Œä¸éœ€è¦æŒ‡å®šå…·ä½“åŸŸå
    server_name _;

    # === Root Directory ===
    
    # è®¾ç½®ç½‘ç«™æ ¹ç›®å½•ï¼Œæ‰€æœ‰é™æ€æ–‡ä»¶éƒ½å­˜æ”¾åœ¨è¿™é‡Œ
    root /usr/share/nginx/html;
    
    # è®¾ç½®é»˜è®¤ç´¢å¼•æ–‡ä»¶ï¼Œå½“è®¿é—®ç›®å½•æ—¶è¿”å› index.html
    index index.html;

    # === SPA Router Fallback ===
    # è§£å†³ React/Vue ç­‰å‰ç«¯åœ¨åˆ·æ–°æ—¶ 404 çš„é—®é¢˜
    
    # å®šä¹‰æ ¹è·¯å¾„çš„ location å—
    location / {
        # å°è¯•æŒ‰é¡ºåºæŸ¥æ‰¾æ–‡ä»¶ï¼š
        # 1. $uri - è¯·æ±‚çš„ URI å¯¹åº”çš„æ–‡ä»¶
        # 2. $uri/ - è¯·æ±‚çš„ URI å¯¹åº”çš„ç›®å½•
        # 3. /index.html - å¦‚æœå‰ä¸¤ä¸ªéƒ½ä¸å­˜åœ¨ï¼Œè¿”å› index.html
        # è¿™æ · SPA åº”ç”¨çš„è·¯ç”±åœ¨åˆ·æ–°æ—¶ä¸ä¼šè¿”å› 404
        try_files $uri $uri/ /index.html;
    }

    # === Gzip Compression ===
    
    # å¯ç”¨ Gzip å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“å¤§å°ï¼Œæå‡æ€§èƒ½
    gzip on;
    
    # ç¦ç”¨å¯¹ IE6 çš„ Gzip å‹ç¼©ï¼ˆIE6 ä¸æ”¯æŒ Gzipï¼‰
    gzip_disable "msie6";
    
    # æ·»åŠ  Vary: Accept-Encoding å“åº”å¤´ï¼Œå‘Šè¯‰ç¼“å­˜æœåŠ¡å™¨æ ¹æ® Accept-Encoding ç¼“å­˜ä¸åŒç‰ˆæœ¬
    gzip_vary on;
    
    # å³ä½¿è¯·æ±‚æ¥è‡ªä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿå¯ç”¨ Gzip å‹ç¼©
    gzip_proxied any;
    
    # è®¾ç½® Gzip å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰ï¼Œ6 æ˜¯æ€§èƒ½å’Œå‹ç¼©ç‡çš„å¹³è¡¡ç‚¹
    gzip_comp_level 6;
    
    # è®¾ç½® Gzip å‹ç¼©ç¼“å†²åŒºå¤§å°å’Œæ•°é‡
    gzip_buffers 16 8k;
    
    # è®¾ç½®å¯ç”¨ Gzip å‹ç¼©çš„æœ€ä½ HTTP ç‰ˆæœ¬
    gzip_http_version 1.1;
    
    # æŒ‡å®šå“ªäº› MIME ç±»å‹å¯ç”¨ Gzip å‹ç¼©
    gzip_types
        text/plain              # çº¯æ–‡æœ¬
        text/css                # CSS æ ·å¼è¡¨
        application/json        # JSON æ•°æ®
        application/javascript  # JavaScript æ–‡ä»¶
        text/xml                # XML æ–‡ä»¶
        application/xml         # XML åº”ç”¨
        application/xml+rss     # RSS è®¢é˜…
        text/javascript         # JavaScript æ–‡æœ¬
        image/svg+xml;          # SVG å›¾ç‰‡

    # === Brotli Compression (if module present) ===
    # è‹¥é•œåƒæ”¯æŒï¼Œå¯å¯ç”¨ä»¥ä¸‹ä¸¤è¡Œï¼š
    # brotli on;  # å¯ç”¨ Brotli å‹ç¼©ï¼ˆæ¯” Gzip å‹ç¼©ç‡æ›´é«˜ï¼‰
    # brotli_types text/plain text/css application/javascript application/json image/svg+xml;  # Brotli å‹ç¼©çš„æ–‡ä»¶ç±»å‹

    # === Cache Control for Static Assets ===
    # å¯¹é™æ€èµ„æºï¼ˆå¸¦ hash çš„æ–‡ä»¶ï¼‰è®¾ç½®é•¿ç¼“å­˜
    
    # åŒ¹é…é™æ€èµ„æºæ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼ location
    # ~* è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…
    # åŒ¹é…çš„æ–‡ä»¶æ‰©å±•åï¼šico, css, js, gif, jpg, jpeg, png, webp, woff, woff2, ttf, svg, eot
    location ~* \.(?:ico|css|js|gif|jpe?g|png|webp|woff2?|ttf|svg|eot)$ {
        # è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 30 å¤©
        expires 30d;
        
        # å…³é—­è®¿é—®æ—¥å¿—è®°å½•ï¼ˆå‡å°‘ I/O å¼€é”€ï¼‰
        access_log off;
        
        # æ·»åŠ  Cache-Control å“åº”å¤´ï¼Œpublic è¡¨ç¤ºå¯ä»¥è¢«ä»»ä½•ç¼“å­˜ç¼“å­˜ï¼Œimmutable è¡¨ç¤ºå†…å®¹ä¸ä¼šæ”¹å˜
        add_header Cache-Control "public, immutable";
        
        # åŒæ ·ä½¿ç”¨ try_filesï¼Œç¡®ä¿ SPA è·¯ç”±æ­£å¸¸å·¥ä½œ
        try_files $uri $uri/ /index.html;
    }

    # === Prevent Caching for HTML ===
    # ç¡®ä¿ index.html æ€»æ˜¯ä»æœåŠ¡å™¨è·å–æœ€æ–°ç‰ˆæœ¬
    
    # åŒ¹é… HTML æ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼ location
    location ~* \.(?:html)$ {
        # è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º -1ï¼Œè¡¨ç¤ºä¸ç¼“å­˜
        expires -1;
        
        # æ·»åŠ  Cache-Control å“åº”å¤´ï¼Œno-cache è¡¨ç¤ºæ¯æ¬¡éƒ½è¦éªŒè¯ç¼“å­˜
        add_header Cache-Control "no-cache";
    }

    # === Favicon & Robots.txt ===
    
    # ç²¾ç¡®åŒ¹é… favicon.ico æ–‡ä»¶
    location = /favicon.ico {
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸åœ¨é”™è¯¯æ—¥å¿—ä¸­è®°å½•
        log_not_found off;
        
        # å…³é—­è®¿é—®æ—¥å¿—è®°å½•
        access_log off;
    }

    # ç²¾ç¡®åŒ¹é… robots.txt æ–‡ä»¶
    location = /robots.txt {
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸åœ¨é”™è¯¯æ—¥å¿—ä¸­è®°å½•
        log_not_found off;
        
        # å…³é—­è®¿é—®æ—¥å¿—è®°å½•
        access_log off;
    }

    # === Security Headers ===
    
    # é˜²æ­¢ MIME ç±»å‹å—…æ¢æ”»å‡»ï¼Œå¼ºåˆ¶æµè§ˆå™¨æŒ‰ç…§ Content-Type å¤„ç†æ–‡ä»¶
    add_header X-Content-Type-Options "nosniff" always;
    
    # é˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»ï¼ŒSAMEORIGIN è¡¨ç¤ºåªå…è®¸åŒæºé¡µé¢åµŒå…¥
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # å¯ç”¨ XSS è¿‡æ»¤å™¨ï¼Œmode=block è¡¨ç¤ºå¦‚æœæ£€æµ‹åˆ° XSS æ”»å‡»åˆ™é˜»æ­¢é¡µé¢åŠ è½½
    add_header X-XSS-Protection "1; mode=block" always;
    
    # è®¾ç½® Referrer ç­–ç•¥ï¼Œstrict-origin-when-cross-origin è¡¨ç¤ºè·¨åŸŸæ—¶åªå‘é€æºä¿¡æ¯
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # è®¾ç½®æƒé™ç­–ç•¥ï¼Œç¦ç”¨ç›¸æœºã€éº¦å…‹é£å’Œåœ°ç†ä½ç½®è®¿é—®
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    # === Error Pages (optional, fallback to index.html) ===
    
    # å½“è¿”å› 404 é”™è¯¯æ—¶ï¼Œé‡å®šå‘åˆ° /index.html
    # è¿™æ ·å¯ä»¥ç¡®ä¿ SPA åº”ç”¨çš„è·¯ç”±æ­£å¸¸å·¥ä½œ
    error_page 404 /index.html;
}
