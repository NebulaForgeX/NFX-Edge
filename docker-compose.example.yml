# Docker Compose æœåŠ¡å®šä¹‰ç¤ºä¾‹
# ä½¿ç”¨æ–¹æ³•ï¼šå¤åˆ¶æ­¤æ–‡ä»¶ä¸º docker-compose.ymlï¼Œç„¶åæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é…ç½®
services:
  # === ğŸ”° Traefik Reverse Proxy ===
  # Traefik åå‘ä»£ç†æœåŠ¡
  reverse-proxy:
    image: traefik:latest
    container_name: NFX-Edge-Reverse-Proxy
    restart: always

    # Traefik å‘½ä»¤è¡Œå‚æ•°
    command:
      # å¯ç”¨ Dashboard + Docker Provider
      - --api.dashboard=true
      - --providers.docker
      - --providers.docker.exposedByDefault=false

      # æ–‡ä»¶é…ç½®ï¼ˆåŠ¨æ€è§„åˆ™ç›®å½•ï¼‰
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true

      # EntryPoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

    # ç«¯å£æ˜ å°„
    ports:
      - "80:80"
      - "443:443"

    # æ•°æ®å·æŒ‚è½½
    volumes:
      # æŒ‚è½½ Docker socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # âœ… æŒ‚è½½æ¯ä¸ªç½‘ç«™çš„è¯ä¹¦ç›®å½•
      # æŒ‚è½½ç½‘ç«™è¯ä¹¦ç›®å½•ï¼Œæ¯ä¸ªç½‘ç«™ä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶å¤¹çš„è¯ä¹¦
      # ä¸å†ä½¿ç”¨ acme.jsonï¼Œæ”¹ä¸ºä½¿ç”¨æ–‡ä»¶è¯ä¹¦ï¼ˆcert.crt å’Œ key.keyï¼‰
      - ${CERTS_DIR}:/certs/websites:ro
      # Traefik ä¸»é…ç½®æ–‡ä»¶
      - ${TRAEFIK_CONFIG_FILE}:/etc/traefik/traefik.yml:ro
      # åŠ¨æ€è§„åˆ™æ–‡ä»¶ç›®å½•
      - ${TRAEFIK_DYNAMIC_DIR}:/etc/traefik/dynamic:ro

    # Traefik è·¯ç”±æ ‡ç­¾
    labels:
      - traefik.enable=true
      # Traefik Dashboardï¼ˆæ ¹æ®å®é™…åŸŸåä¿®æ”¹ traefik.example.comï¼‰
      # è¯ä¹¦é…ç½®åœ¨ dynamic/certs.yml ä¸­ç»Ÿä¸€ç®¡ç†
      - traefik.http.routers.web-dashboard.rule=Host(`traefik.example.com`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
      - traefik.http.routers.web-dashboard.entrypoints=websecure
      - traefik.http.routers.web-dashboard.tls=true
      - traefik.http.routers.web-dashboard.service=api@internal
      # BasicAuth å¯†ç å“ˆå¸Œï¼ˆéœ€è¦æ ¹æ®å®é™…å¯†ç ç”Ÿæˆï¼Œä½¿ç”¨ htpasswd å·¥å…·ï¼‰
      - traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$2y$$05$$KymEIDjaRPneTxHf1RCzruglmhsOdj2KQJhG6qKAUbtFkG0kCVJ/e$$
      - traefik.http.routers.web-dashboard.middlewares=dashboard-auth

    # ç½‘ç»œé…ç½®
    networks:
      - nfx-edge

  # === ğŸŒ¿ ç¤ºä¾‹ç½‘ç«™æœåŠ¡ ===
  # ç½‘ç«™æœåŠ¡æ¨¡æ¿ï¼ˆå¤åˆ¶æ­¤æœåŠ¡å¹¶ä¿®æ”¹é…ç½®å³å¯æ·»åŠ æ–°ç½‘ç«™ï¼‰
  www_example:
    image: nginx:alpine
    # æ ¹æ®å®é™…ç½‘ç«™ä¿®æ”¹å®¹å™¨åç§°
    container_name: NFX-Edge-WWW-EXAMPLE
    restart: always

    # æ•°æ®å·æŒ‚è½½
    volumes:
      # ä¿®æ”¹ä¸ºå®é™…çš„ç½‘ç«™æ–‡ä»¶ç›®å½•
      - ./www.example.com:/usr/share/nginx/html:ro
      # Nginx é…ç½®æ–‡ä»¶
      - ${NGINX_CONFIG_FILE}:/etc/nginx/conf.d/default.conf:ro

    # Traefik è·¯ç”±æ ‡ç­¾
    labels:
      - traefik.enable=true
      # ä¿®æ”¹ä¸ºå®é™…çš„åŸŸå
      # è¯ä¹¦é…ç½®åœ¨ dynamic/certs.yml ä¸­ç»Ÿä¸€ç®¡ç†
      - traefik.http.routers.example.rule=Host(`example.com`) || Host(`www.example.com`)
      - traefik.http.routers.example.entrypoints=websecure
      - traefik.http.routers.example.tls=true

    # ç½‘ç»œé…ç½®
    networks:
      - nfx-edge

    # æœåŠ¡ä¾èµ–
    depends_on:
      - reverse-proxy

  # === âš™ï¸ ç¤ºä¾‹ç®¡ç†åå°æœåŠ¡ ===
  # ç®¡ç†åå°æœåŠ¡æ¨¡æ¿ï¼ˆå¤åˆ¶æ­¤æœåŠ¡å¹¶ä¿®æ”¹é…ç½®å³å¯æ·»åŠ æ–°ç®¡ç†åå°ï¼‰
  admin_example:
    image: nginx:alpine
    # æ ¹æ®å®é™…ç®¡ç†åå°ä¿®æ”¹å®¹å™¨åç§°
    container_name: NFX-Edge-Admin-EXAMPLE
    restart: always

    # æ•°æ®å·æŒ‚è½½
    volumes:
      # ä¿®æ”¹ä¸ºå®é™…çš„ç®¡ç†åå°æ–‡ä»¶ç›®å½•
      - ./admin.example.com:/usr/share/nginx/html:ro
      # Nginx é…ç½®æ–‡ä»¶
      - ${NGINX_CONFIG_FILE}:/etc/nginx/conf.d/default.conf:ro

    # Traefik è·¯ç”±æ ‡ç­¾
    labels:
      - traefik.enable=true
      # ä¿®æ”¹ä¸ºå®é™…çš„åŸŸåï¼ˆé€šå¸¸ä½¿ç”¨ admin. å‰ç¼€ï¼‰
      # è¯ä¹¦é…ç½®åœ¨ dynamic/certs.yml ä¸­ç»Ÿä¸€ç®¡ç†
      - traefik.http.routers.admin-example.rule=Host(`admin.example.com`)
      - traefik.http.routers.admin-example.entrypoints=websecure
      - traefik.http.routers.admin-example.tls=true

    # ç½‘ç»œé…ç½®
    networks:
      - nfx-edge

    # æœåŠ¡ä¾èµ–
    depends_on:
      - reverse-proxy

# ç½‘ç»œå®šä¹‰
networks:
  nfx-edge:
    name: nfx-edge
    driver: bridge
